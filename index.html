<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رزرو نوبت سالن</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* All original CSS styles are preserved exactly as they were. */
        body {
            font-family: 'Inter', 'Vazirmatn', sans-serif;
            background-color: #fdf2f8; /* pink-50 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            color: #374151; /* gray-700 */
        }

        .app-container {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            width: 100%;
            max-width: 28rem; /* max-w-md */
            position: relative;
        }

        .step {
            display: none;
        }

            .step.active {
                display: block;
            }

        .btn {
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 700; /* font-bold */
            transition: background-color 0.15s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            text-align: center;
        }

            .btn:disabled {
                background-color: #9ca3af; /* gray-400 */
                cursor: not-allowed;
            }

        .btn-primary {
            background-color: #ec4899;
            color: white;
        }
            /* pink-500 */
            .btn-primary:hover:not(:disabled) {
                background-color: #db2777;
            }
        /* pink-600 */
        .btn-secondary {
            background-color: #d1d5db;
            color: #1f2937;
        }
            /* gray-300, gray-800 */
            .btn-secondary:hover {
                background-color: #9ca3af;
            }
        /* gray-400 */
        .btn-success {
            background-color: #22c55e;
            color: white;
        }
            /* green-500 */
            .btn-success:hover {
                background-color: #16a34a;
            }
        /* green-600 */
        .btn-info {
            background-color: #3b82f6;
            color: white;
        }
            /* blue-500 */
            .btn-info:hover {
                background-color: #2563eb;
            }
        /* blue-600 */
        .input-field {
            width: 100%;
            padding: 0.75rem; /* p-3 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
        }

        .error-message {
            color: #ef4444; /* red-500 */
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }

        .loading-message {
            text-align: center;
            margin-y: 1rem;
            color: #71717a;
        }
        /* zinc-500 */
        .progress-bar-bg {
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px; /* rounded-full */
            margin-bottom: 0.25rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #ec4899;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }

        .calendar-month-container {
            margin-bottom: 1.5rem;
        }

        .calendar-month-header {
            text-align: center;
            font-semibold text-lg text-pink-700 mb-2;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .calendar-day-header {
            font-medium text-xs text-gray-500;
            padding: 0.25rem;
        }

        .calendar-day {
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: background-color 0.15s, border-color 0.15s;
            font-size: 0.875rem;
        }

            .calendar-day.selected {
                background-color: #ec4899;
                color: white;
                border-color: #ec4899;
                font-weight: bold;
            }

            .calendar-day.disabled {
                background-color: #f3f4f6;
                color: #9ca3af;
                cursor: not-allowed;
                text-decoration: line-through;
            }

            .calendar-day.current-day {
                border: 2px solid #db2777; /* pink-600 */
                font-weight: bold;
            }

            .calendar-day.empty {
                background-color: transparent;
                border: none;
                cursor: default;
            }

        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .time-slot-btn {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            transition: background-color 0.15s, border-color 0.15s;
            font-size: 0.875rem;
        }

            .time-slot-btn.selected {
                background-color: #ec4899;
                color: white;
                border-color: #ec4899;
            }

            .time-slot-btn:not(.selected):hover {
                background-color: #fce7f3;
                border-color: #f9a8d4;
            }

        .list-item {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            margin-bottom: 0.75rem;
        }

            .list-item:hover {
                background-color: #fce7f3;
                border-color: #f9a8d4;
            }

            .list-item.selected {
                background-color: #fce7f3;
                border-color: #f472b6;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .referral-code-display {
            background-color: #fce7f3;
            border: 1px dashed #f472b6;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .referral-code-text {
            font-weight: bold;
            font-size: 1.125rem;
            color: #be185d;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            user-select: all;
        }

        .salon-card {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .salon-card-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #be185d;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .salon-card-detail {
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        #initialAppLoading {
            text-align: center;
            padding: 2rem;
            font-size: 1.125rem;
            color: #be185d;
        }
    </style>
</head>
<body>

    <div id="initialAppLoading" class="loading-message">در حال بارگذاری برنامه...</div>

    <div id="mainAppContainer" class="app-container" style="display: none;">
        <!-- All step divs from your original HTML are preserved here -->
        <div id="progressBarContainer" class="mb-6" style="display: none;">
            <div class="progress-bar-bg"><div id="progressBar" class="progress-bar"></div></div>
            <p id="progressText" class="text-xs text-center text-gray-500 mt-1"></p>
        </div>

        <div id="step1" class="step">
            <h2 class="text-2xl font-semibold mb-6 text-center">سامانه رزرو نوبت قطعی</h2>
            <div class="flex flex-row gap-2 mb-4">
                <div class="flex-1">
                    <select id="categoryFilter" class="input-field w-full">
                        <option value="همه">همه دسته بندی ها</option>
                        <option value="زیبایی و آرایشی">زیبایی و آرایشی</option>
                        <option value="پزشکی و سلامت">پزشکی و سلامت</option>
                        <option value="حرفه‌ای و مشاوره‌ای">حرفه‌ای و مشاوره‌ای</option>
                        <option value="خودرو و تعمیرات">خودرو و تعمیرات</option>
                        <option value="ورزشی و تفریحی">ورزشی و تفریحی</option>
                    </select>
                </div>
                <div class="flex-1">
                    <select id="cityFilter" class="input-field w-full"><option value="همه">همه شهر ها</option></select>
                </div>
            </div>
            <div id="salonListContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            <p id="errorStep1" class="error-message"></p>
            <p id="loadingStep1" class="loading-message" style="display: none;">در حال بارگذاری لیست سالن‌ها...</p>
            <div class="mt-6 text-center">
                <a href="#" target="_blank" class="btn btn-primary w-full block text-center">همه رزروهای من</a>
                <a href="#" target="_blank" class="inline-block mt-4 text-sm text-blue-600 hover:underline">خودم صاحب کسب و کار هستم</a>
            </div>
        </div>

        <div id="step2" class="step">
            <div id="salonCardDisplay" class="salon-card">
                <h3 id="salonCardName" class="salon-card-title"></h3>
                <p id="salonCardCategoryCity" class="text-xs font-semibold text-blue-600 text-center mb-4"></p>
                <p id="salonCardAddress" class="salon-card-detail"></p>
                <p id="salonCardPhone" class="salon-card-detail"></p>
            </div>
            <button id="btnGoToStep3FromCard" class="btn btn-primary flex-grow w-full">رزرو نوبت</button>
            <p id="errorStep2" class="error-message"></p>
        </div>

        <div id="step3" class="step">
            <h2 class="text-2xl font-semibold mb-2 text-center">ورود شماره تماس</h2>
            <p id="selectedSalonInfoForPhoneStep" class="text-center text-sm text-gray-600 mb-4"></p>
            <input type="tel" id="phoneNumberInput" placeholder="مثال: 09123456789" class="input-field text-left dir-ltr mb-4" maxlength="11">
            <div class="flex gap-2">
                <button id="btnBackToStep2FromPhone" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnGoToStep4FromPhone" class="btn btn-primary flex-1">ادامه</button>
            </div>
            <p id="errorStep3" class="error-message"></p>
        </div>

        <div id="step4" class="step">
            <h2 class="text-2xl font-semibold mb-4 text-center">کد تایید را وارد کنید</h2>
            <p id="otpSentTo" class="mb-3 text-center text-sm text-gray-600"></p>
            <p id="generatedOtpDisplay" class="mb-3 text-center text-sm text-blue-600 font-semibold"></p>
            <input type="number" id="otpInput" placeholder="کد ۴ رقمی" class="input-field text-center dir-ltr mb-4" maxlength="4">
            <div class="flex gap-2">
                <button id="btnBackToStep3FromOtp" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnGoToStep5FromOtp" class="btn btn-primary flex-1">تایید کد</button>
            </div>
            <p id="errorStep4" class="error-message"></p>
            <p id="loadingStep4" class="loading-message" style="display: none;">در حال تایید...</p>
        </div>

        <div id="step5" class="step">
            <h2 class="text-2xl font-semibold mb-4 text-center">اطلاعات مشتری</h2>
            <div id="customerInfoDisplay" class="bg-pink-50 p-4 rounded-lg mb-6 shadow">
                <p>شماره تماس: <span id="customerInfoPhone" class="font-semibold"></span></p>
                <p id="customerInfoNameContainer" style="display:none;">نام: <span id="customerInfoName" class="font-semibold"></span></p>
                <p>تعداد مراجعه قبلی: <span id="customerInfoVisits" class="font-semibold"></span></p>
                <p>درصد تخفیف شما: <span id="customerInfoDiscount" class="font-semibold text-green-600"></span></p>
            </div>
            <div id="customerNameInputContainer" class="mb-4">
                <label for="customerNameInput" class="block text-sm font-medium text-gray-700 mb-1">نام شما</label>
                <input type="text" id="customerNameInput" class="input-field mb-4" placeholder="نام خود را وارد کنید">
            </div>
            <div class="flex gap-2">
                <button id="btnBackToStep4FromCust" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnProceedFromCustomerInfo" class="btn btn-primary flex-1">انتخاب خدمات</button>
            </div>
            <p id="errorStep5" class="error-message"></p>
        </div>

        <div id="step6" class="step">
            <h2 class="text-2xl font-semibold mb-2 text-center">انتخاب دسته‌بندی</h2>
            <p id="salonNameForCategories" class="text-center text-lg text-gray-600 mb-4"></p>
            <div id="categoryListContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
            <div class="flex gap-2 mt-6"><button id="btnBackToStep5FromCatList" class="btn btn-secondary flex-1">بازگشت</button></div>
            <p id="errorStep6" class="error-message"></p>
        </div>

        <div id="step7" class="step">
            <h2 class="text-2xl font-semibold mb-2 text-center">انتخاب خدمات</h2>
            <p id="salonAndCategoryInfoForServices" class="text-center text-sm text-gray-600 mb-4"></p>
            <div id="servicesList" class="space-y-3 mb-6 max-h-96 overflow-y-auto pr-2"></div>
            <div id="serviceSummary" class="bg-pink-50 p-4 rounded-lg mb-6 shadow" style="display: none;">
                <h3 class="text-lg font-semibold mb-2 text-pink-800">خلاصه انتخاب:</h3>
                <p>مبلغ نهایی: <span id="summaryFinalPrice"></span> تومان</p>
                <p>مجموع مدت زمان: <span id="summaryTotalDuration"></span> ساعت</p>
            </div>
            <div class="flex gap-2">
                <button id="btnBackToStep6FromServices" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnGoToStep8FromServices" class="btn btn-primary flex-1" disabled>انتخاب تاریخ</button>
            </div>
            <p id="errorStep7" class="error-message"></p>
        </div>

        <div id="step8" class="step">
            <h2 class="text-2xl font-semibold mb-1 text-center">انتخاب تاریخ مراجعه</h2>
            <div id="calendarsContainer" class="space-y-6"></div>
            <div class="flex gap-2 mt-4">
                <button id="btnBackToStep7FromDate" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnGoToStep9FromDate" class="btn btn-primary flex-1" disabled>انتخاب ساعت</button>
            </div>
            <p id="errorStep8" class="error-message"></p>
        </div>

        <div id="step9" class="step">
            <h2 class="text-2xl font-semibold mb-1 text-center">انتخاب ساعت مراجعه</h2>
            <p id="selectedDateInfo" class="text-center text-gray-600 mb-4"></p>
            <p id="loadingStep9Time" class="loading-message" style="display: none;">در حال بررسی ساعت‌های موجود...</p>
            <div id="timeSlotsContainer" class="time-slot-grid"></div>
            <p id="noTimeSlotsMessage" class="text-center my-4 text-orange-600" style="display:none;">متاسفانه هیچ ساعت خالی یافت نشد.</p>
            <div class="flex gap-2">
                <button id="btnBackToStep8FromTime" class="btn btn-secondary flex-1">بازگشت</button>
                <button id="btnGoToStep10FromTime" class="btn btn-primary flex-1" disabled>ثبت نهایی رزرو</button>
            </div>
            <p id="errorStep9" class="error-message"></p>
        </div>

        <div id="step11" class="step">
            <div class="text-center">
                <div id="confirmationIcon"></div>
                <h2 id="confirmationTitle" class="text-2xl font-semibold mb-3"></h2>
                <div id="confirmationDetails" class="bg-gray-50 p-4 rounded-lg mb-6 text-right shadow-inner text-sm">
                    <p id="confSalonName" class="font-bold text-lg mb-2"></p>
                    <p id="confSalonAddress"></p>
                    <p>تاریخ مراجعه: <span id="confDate" class="font-semibold"></span></p>
                    <p>ساعت مراجعه: <span id="confTime" class="font-semibold"></span></p>
                </div>
                <button onclick="resetApp()" class="btn btn-primary w-full block">رزرو جدید</button>
            </div>
        </div>
    </div>
    <div id="customMessageBox" class="message-box"></div>

    <script>
        // --- GLOBAL STATE ---
        const API_BASE_URL = 'https://fanoos.me/api/booking';
        let currentStep = 1;
        let allSalonsMaster = []; // To store the master list of salons
        let selectedSalon = null;
        let selectedCategory = null;
        let phoneNumber = '';
        let customerData = null;
        let selectedServices = [];
        let selectedDate = null;
        let selectedTimeSlot = null;
        let dailyBookedSlots = {}; // Cache for booked slots { 'yyyy-mm-dd': [bookings] }

        const JALALI_MONTH_NAMES = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        const JALALI_WEEK_DAYS = ["یکشنبه", "دوشنبه", "سه‌شنبه", "چهارشنبه", "پنج‌شنبه", "جمعه", "شنبه"];

        // --- DOM ELEMENTS ---
        const stepsDOM = Array.from(document.querySelectorAll('.step'));
        const initialAppLoadingDOM = document.getElementById('initialAppLoading');
        const mainAppContainerDOM = document.getElementById('mainAppContainer');

        // --- UTILITY FUNCTIONS ---
        // Date converters and text formatters are preserved from the original file.
        function gregorianToJalali(gy, gm, gd) { let g_d_m, jy, jm, jd, gy2, days; g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334]; gy2 = (gm > 2) ? (gy + 1) : gy; days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4) - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400) + gd + g_d_m[gm - 1]; jy = -1595 + (33 * Math.floor(days / 12053)); days %= 12053; jy += 4 * Math.floor(days / 1461); days %= 1461; if (days > 365) { jy += Math.floor((days - 1) / 365); days = (days - 1) % 365; } if (days < 186) { jm = 1 + Math.floor(days / 31); jd = 1 + (days % 31); } else { jm = 7 + Math.floor((days - 186) / 30); jd = 1 + ((days - 186) % 30); } return [jy, jm, jd]; }
        function jalaliToGregorian(jy, jm, jd) { let sal_a, gy, gm, gd, days; jy += 1595; days = -355668 + (365 * jy) + (Math.floor(jy / 33) * 8) + Math.floor(((jy % 33) + 3) / 4) + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186); gy = 400 * Math.floor(days / 146097); days %= 146097; if (days > 36524) { gy += 100 * Math.floor(--days / 36524); days %= 36524; if (days >= 365) days++; } gy += 4 * Math.floor(days / 1461); days %= 1461; if (days > 365) { gy += Math.floor((days - 1) / 365); days = (days - 1) % 365; } gd = days + 1; sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) gd -= sal_a[gm]; return [gy, gm, gd]; }
        const toPersianNum = (n) => { if (n === null || n === undefined) return ''; const persianDigits = '۰۱۲۳۴۵۶۷۸۹'; return String(n).replace(/\d/g, d => persianDigits[d]); };
        const toEnglishNum = (s) => { if (s === null || s === undefined) return ''; const persianDigits = '۰۱۲۳۴۵۶۷۸۹'; return String(s).replace(/[۰-۹]/g, d => persianDigits.indexOf(d)); };
        function showMessage(message, duration = 3000) { const el = document.getElementById('customMessageBox'); el.textContent = message; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, duration); }
        function navigateToStep(stepNumber) { stepsDOM.forEach(s => s.classList.remove('active')); const targetStep = document.getElementById(`step${stepNumber}`); if (targetStep) { targetStep.classList.add('active'); currentStep = stepNumber; } window.scrollTo({ top: mainAppContainerDOM.offsetTop - 20, behavior: 'smooth' }); }
        function displayError(stepId, message) { const el = document.getElementById(`errorStep${stepId}`); if (el) el.textContent = message; }
        function clearAllErrors() { document.querySelectorAll('.error-message').forEach(el => el.textContent = ''); }
        function setLoading(stepId, isLoading, elementIdSuffix = '') { const el = document.getElementById(`loadingStep${stepId}${elementIdSuffix}`); if (el) el.style.display = isLoading ? 'block' : 'none'; }

        // --- API INTERACTION ---
        async function fetchApi(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorJson;
                    try {
                        errorJson = JSON.parse(errorText);
                    } catch (e) {
                        throw new Error(`خطای سرور: ${response.status} - ${errorText}`);
                    }
                    throw new Error(errorJson.message || errorJson.title || 'خطای ناشناخته از سرور.');
                }
                const contentType = response.headers.get("content-type");
                return (contentType && contentType.includes("application/json")) ? response.json() : null;
            } catch (error) {
                console.error('API Fetch Error:', error.message);
                throw error;
            }
        }

        // --- APP LOGIC BY STEP ---

        // STEP 1: Salon List
        async function initStep1() {
            setLoading(1, true);
            clearAllErrors();
            try {
                const salons = await fetchApi('salons');
                allSalonsMaster = salons;
                populateCityFilter(salons);
                applyFiltersAndPopulateSalons();
            } catch (error) {
                displayError(1, error.message);
            } finally {
                setLoading(1, false);
            }
        }

        function populateCityFilter(salons) {
            const cityFilter = document.getElementById('cityFilter');
            if (cityFilter.options.length > 1) return; // Populate only once
            const uniqueCities = [...new Set(salons.map(s => s.city).filter(Boolean))].sort();
            uniqueCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            });
        }

        function applyFiltersAndPopulateSalons() {
            const cityFilterValue = document.getElementById('cityFilter').value;
            const categoryFilterValue = document.getElementById('categoryFilter').value;

            let filteredSalons = allSalonsMaster;

            if (cityFilterValue !== 'همه') {
                filteredSalons = filteredSalons.filter(s => s.city === cityFilterValue);
            }
            if (categoryFilterValue !== 'همه') {
                filteredSalons = filteredSalons.filter(s => s.mainCategory === categoryFilterValue);
            }

            const container = document.getElementById('salonListContainer');
            container.innerHTML = '';
            if (!filteredSalons || filteredSalons.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">هیچ سالنی با این مشخصات یافت نشد.</p>';
                return;
            }
            filteredSalons.forEach(salon => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                        <h3 class="text-lg font-semibold text-pink-700 mb-1">${salon.name}</h3>
                        <p class="text-xs font-semibold text-blue-600">${salon.mainCategory || ''} - ${salon.city || ''}</p>
                        <p class="text-sm text-gray-600 mt-2">${salon.address || ''}</p>
                        <p class="text-xs text-gray-500 mt-1">تلفن: ${toPersianNum(salon.phone) || ''}</p>
                    `;
                div.onclick = () => handleSalonSelect(salon.salonId);
                container.appendChild(div);
            });
        }

        async function handleSalonSelect(salonId) {
            selectedSalon = allSalonsMaster.find(s => s.salonId === salonId);
            if (typeof selectedSalon.workHoursJson === 'string' && selectedSalon.workHoursJson) {
                try {
                    selectedSalon.workHours = JSON.parse(selectedSalon.workHoursJson);
                } catch (e) { console.error("Failed to parse WorkHoursJson", e); selectedSalon.workHours = {}; }
            } else {
                selectedSalon.workHours = {}; // Set a default if null or not a string
            }
            populateSalonBusinessCardStep2();
            navigateToStep(2);
        }

        // STEP 2: Salon Details
        function populateSalonBusinessCardStep2() {
            clearAllErrors();
            document.getElementById('salonCardName').textContent = selectedSalon.name;
            document.getElementById('salonCardCategoryCity').textContent = `${selectedSalon.mainCategory || ''} - ${selectedSalon.city || ''}`;
            document.getElementById('salonCardAddress').textContent = `آدرس: ${selectedSalon.address || ''}`;
            document.getElementById('salonCardPhone').textContent = `تلفن: ${toPersianNum(selectedSalon.phone) || ''}`;
        }

        // STEP 3 & 4: Phone & OTP
        function initStep3() {
            clearAllErrors();
            document.getElementById('selectedSalonInfoForPhoneStep').textContent = `رزرو وقت در ${selectedSalon.name}`;
            document.getElementById('phoneNumberInput').value = '';
            navigateToStep(3);
        }

        async function handlePhoneNumberSubmit() {
            clearAllErrors();
            phoneNumber = toEnglishNum(document.getElementById('phoneNumberInput').value);
            if (!phoneNumber.match(/^09\d{9}$/)) {
                displayError(3, "لطفا شماره تماس معتبر (مثال: 09123456789) وارد کنید.");
                return;
            }
            try {
                const data = await fetchApi('request-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber })
                });
                document.getElementById('otpSentTo').textContent = `کد تایید به شماره ${toPersianNum(phoneNumber)} ارسال شد.`;
                document.getElementById('generatedOtpDisplay').textContent = `کد تایید (برای تست): ${toPersianNum(data.testOtp)}`;
                document.getElementById('otpInput').value = '';
                navigateToStep(4);
            } catch (error) {
                displayError(3, error.message);
            }
        }

        async function handleUserOtpVerification() {
            clearAllErrors();
            setLoading(4, true);
            const userEnteredOtp = toEnglishNum(document.getElementById('otpInput').value);
            try {
                customerData = await fetchApi('verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber, otp: userEnteredOtp })
                });
                populateCustomerInfoStep5();
                navigateToStep(5);
            } catch (error) {
                displayError(4, error.message);
            } finally {
                setLoading(4, false);
            }
        }

        // STEP 5: Customer Info
        function populateCustomerInfoStep5() {
            document.getElementById('customerInfoPhone').textContent = toPersianNum(customerData.phoneNumber);
            document.getElementById('customerInfoVisits').textContent = toPersianNum(customerData.visitsCount || 0);
            document.getElementById('customerInfoDiscount').textContent = `${toPersianNum(customerData.discountPercentage || 0)}٪`;
            document.getElementById('customerNameInput').value = customerData.name || '';
            const nameContainer = document.getElementById('customerInfoNameContainer');
            if (customerData.name) {
                document.getElementById('customerInfoName').textContent = customerData.name;
                nameContainer.style.display = 'block';
                document.getElementById('customerNameInputContainer').style.display = 'none';
            } else {
                nameContainer.style.display = 'none';
                document.getElementById('customerNameInputContainer').style.display = 'block';
            }
        }

        async function handleCustomerDetailsSubmitStep5() {
            clearAllErrors();
            const customerName = document.getElementById('customerNameInput').value;
            // Only update if name is new and provided
            if (!customerData.name && customerName) {
                customerData.name = customerName;
                try {
                    await fetchApi('update-customer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(customerData)
                    });
                } catch (error) {
                    displayError(5, `خطا در ذخیره نام: ${error.message}`);
                    return; // Stop if saving name fails
                }
            }

            if (selectedSalon.categories && selectedSalon.categories.length === 1) {
                selectedCategory = selectedSalon.categories[0];
                populateServicesStep7();
                navigateToStep(7);
            } else {
                populateSalonCategoriesStep6();
                navigateToStep(6);
            }
        }

        // STEP 6: Category List
        function populateSalonCategoriesStep6() {
            clearAllErrors();
            document.getElementById('salonNameForCategories').textContent = selectedSalon.name;
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = '';
            if (!selectedSalon.categories || selectedSalon.categories.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">هیچ دسته‌بندی برای این سالن یافت نشد.</p>';
                return;
            }
            selectedSalon.categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.textContent = category.name;
                div.onclick = () => { selectedCategory = category; populateServicesStep7(); navigateToStep(7); };
                container.appendChild(div);
            });
        }

        // STEP 7: Service List
        function populateServicesStep7() {
            clearAllErrors();
            document.getElementById('salonAndCategoryInfoForServices').textContent = `${selectedCategory.name} در ${selectedSalon.name}`;
            const container = document.getElementById('servicesList');
            container.innerHTML = '';
            if (!selectedCategory.services || selectedCategory.services.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">هیچ خدمتی در این دسته‌بندی یافت نشد.</p>';
                updateServiceSummaryStep7(); return;
            }
            selectedCategory.services.forEach(service => {
                const isSelected = selectedServices.some(s => s.id === service.id);
                const serviceDiv = document.createElement('div');
                serviceDiv.className = `list-item ${isSelected ? 'selected' : ''}`;
                serviceDiv.onclick = () => toggleServiceStep7(service);
                serviceDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-pink-700">${service.name}</h3>
                            ${isSelected ? '<span class="text-pink-500 text-2xl">✓</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${toPersianNum(service.price.toLocaleString())} تومان</div>
                        <p class="text-xs text-gray-500 mt-1">مدت زمان: ${toPersianNum(service.durationHours)} ساعت</p>`;
                container.appendChild(serviceDiv);
            });
            updateServiceSummaryStep7();
        }

        function toggleServiceStep7(service) {
            const index = selectedServices.findIndex(s => s.id === service.id);
            if (index > -1) selectedServices.splice(index, 1);
            else selectedServices.push(service);
            populateServicesStep7();
        }

        function updateServiceSummaryStep7() {
            const summaryEl = document.getElementById('serviceSummary');
            const nextButton = document.getElementById('btnGoToStep8FromServices');
            if (selectedServices.length === 0) {
                summaryEl.style.display = 'none';
                nextButton.disabled = true;
                return;
            }
            summaryEl.style.display = 'block';
            nextButton.disabled = false;

            const totalFinalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.durationHours, 0);

            document.getElementById('summaryFinalPrice').textContent = toPersianNum(totalFinalPrice.toLocaleString());
            document.getElementById('summaryTotalDuration').textContent = toPersianNum(totalDuration);
        }

        // STEP 8: Date Selection
        function populateCalendarsStep8() {
            clearAllErrors();
            const container = document.getElementById('calendarsContainer');
            container.innerHTML = '';
            const today = new Date();
            const [currentJYear, currentJMonth, currentJDay] = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            container.appendChild(renderMonthCalendar(currentJYear, currentJMonth, currentJDay));
            const nextMonthValue = (currentJMonth === 12) ? 1 : currentJMonth + 1;
            const nextMonthYear = (currentJMonth === 12) ? currentJYear + 1 : currentJYear;
            const nextMonthCalendar = renderMonthCalendar(nextMonthYear, nextMonthValue, -1);
            container.appendChild(nextMonthCalendar);
            document.getElementById('btnGoToStep9FromDate').disabled = !selectedDate;
        }

        function renderMonthCalendar(year, month, currentJDay) { // month is 1-12
            const monthContainer = document.createElement('div');
            monthContainer.className = 'calendar-month-container';
            const [gYear, gMonth, gDay] = jalaliToGregorian(year, month, 1);
            const firstDayOfWeek = new Date(gYear, gMonth - 1, gDay).getDay();
            const dayOffset = (firstDayOfWeek + 1) % 7;
            const daysInThisMonth = (month <= 6) ? 31 : (month <= 11) ? 30 : ((new Date(jalaliToGregorian(year, month, 30)[0], 2, 0).getDate() === 29) ? 30 : 29);

            monthContainer.innerHTML = `<div class="calendar-month-header">${JALALI_MONTH_NAMES[month - 1]} ${toPersianNum(year)}</div>
                    <div class="calendar-grid"><div class="calendar-day-header">ش</div><div class="calendar-day-header">ی</div><div class="calendar-day-header">د</div><div class="calendar-day-header">س</div><div class="calendar-day-header">چ</div><div class="calendar-day-header">پ</div><div class="calendar-day-header">ج</div></div>
                    <div id="calendar-days-${year}-${month}" class="calendar-grid"></div>`;

            const daysContainer = monthContainer.querySelector(`#calendar-days-${year}-${month}`);
            const today = new Date();
            const [todayJYear, todayJMonth, todayJDay] = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());

            for (let i = 0; i < dayOffset; i++) { daysContainer.innerHTML += '<div class="calendar-day empty"></div>'; }

            for (let day = 1; day <= daysInThisMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                let isPastDay = (year < todayJYear || (year === todayJYear && month < todayJMonth) || (year === todayJYear && month === todayJMonth && day < todayJDay));
                const [gY, gM, gD] = jalaliToGregorian(year, month, day);
                const dayOfWeekName = JALALI_WEEK_DAYS[new Date(gY, gM - 1, gD).getDay()];
                const workDayInfo = selectedSalon.workHours ? selectedSalon.workHours[dayOfWeekName] : null;
                const isSelectable = workDayInfo?.active === true && !isPastDay;

                dayDiv.textContent = toPersianNum(day);
                if (day === currentJDay && month === todayJMonth && year === todayJYear) dayDiv.classList.add('current-day');
                if (selectedDate && selectedDate.day === day && selectedDate.month === month && selectedDate.year === year) dayDiv.classList.add('selected');

                if (isSelectable) {
                    dayDiv.onclick = () => { selectedDate = { day, month, year, full: `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}` }; selectedTimeSlot = null; populateCalendarsStep8(); };
                } else {
                    dayDiv.classList.add('disabled');
                }
                daysContainer.appendChild(dayDiv);
            }
            return monthContainer;
        }

        // STEP 9: Time Selection
        async function populateTimeSlotsStep9() {
            clearAllErrors();
            setLoading(9, true, 'Time');
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.durationHours, 0);
            document.getElementById('selectedDateInfo').textContent = `تاریخ انتخابی: ${toPersianNum(selectedDate.full)} (مدت زمان خدمات: ${toPersianNum(totalDuration)} ساعت)`;
            const container = document.getElementById('timeSlotsContainer');
            container.innerHTML = '';
            document.getElementById('btnGoToStep10FromTime').disabled = true;

            try {
                const dateKey = selectedDate.full.replace(/\//g, '-'); // Use yyyy-mm-dd format for key
                const bookings = await fetchApi(`bookings-by-date?salonId=${selectedSalon.salonId}&date=${selectedDate.full}`);
                dailyBookedSlots[dateKey] = bookings.map(b => ({
                    start: parseFloat(b.startTime.split(':')[0]) + parseFloat(b.startTime.split(':')[1]) / 60,
                    end: parseFloat(b.endTime.split(':')[0]) + parseFloat(b.endTime.split(':')[1]) / 60,
                }));
            } catch (e) {
                displayError(9, "خطا در دریافت رزروهای قبلی: " + e.message);
                setLoading(9, false, 'Time');
                return;
            }

            const availableTimeSlots = generateTimeSlotsStep9();
            document.getElementById('noTimeSlotsMessage').style.display = availableTimeSlots.length === 0 ? 'block' : 'none';
            availableTimeSlots.forEach(slot => {
                const slotButton = document.createElement('button');
                slotButton.className = 'time-slot-btn';
                slotButton.textContent = toPersianNum(slot);
                if (selectedTimeSlot === slot) slotButton.classList.add('selected');
                slotButton.onclick = () => { selectedTimeSlot = slot; populateTimeSlotsStep9(); };
                container.appendChild(slotButton);
            });
            if (selectedTimeSlot) { document.getElementById('btnGoToStep10FromTime').disabled = false; }
            setLoading(9, false, 'Time');
        }

        function generateTimeSlotsStep9() {
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.durationHours, 0);
            if (!selectedDate || totalDuration === 0) return [];

            const [gY, gM, gD] = jalaliToGregorian(selectedDate.year, selectedDate.month, selectedDate.day);
            const dayOfWeekName = JALALI_WEEK_DAYS[new Date(gY, gM - 1, gD).getDay()];
            const workDayInfo = selectedSalon.workHours ? selectedSalon.workHours[dayOfWeekName] : null;

            if (!workDayInfo || !workDayInfo.active) return [];

            const slots = [];
            const workStart = parseFloat(workDayInfo.start.split(':')[0]) + parseFloat(workDayInfo.start.split(':')[1]) / 60;
            const workEnd = parseFloat(workDayInfo.end.split(':')[0]) + parseFloat(workDayInfo.end.split(':')[1]) / 60;
            const dateKey = selectedDate.full.replace(/\//g, '-');
            const bookedForDay = dailyBookedSlots[dateKey] || [];

            for (let slotStart = workStart; slotStart + totalDuration <= workEnd; slotStart += 0.5) { // 30 min intervals
                const slotEnd = slotStart + totalDuration;
                let isOverlapping = bookedForDay.some(booking => Math.max(slotStart, booking.start) < Math.min(slotEnd, booking.end));
                if (!isOverlapping) {
                    const hour = Math.floor(slotStart);
                    const minute = (slotStart - hour) * 60;
                    slots.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
                }
            }
            return slots;
        }

        // STEP 10 (Simplified to final booking) & 11: Confirmation
        async function handleFinalBooking() {
            clearAllErrors();
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.durationHours, 0);
            const startTimeDecimal = parseFloat(selectedTimeSlot.split(':')[0]) + parseFloat(selectedTimeSlot.split(':')[1]) / 60;
            const endTimeDecimal = startTimeDecimal + totalDuration;
            const endHour = Math.floor(endTimeDecimal);
            const endMinute = Math.round((endTimeDecimal - endHour) * 60);
            const finalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);

            const bookingPayload = {
                salonId: selectedSalon.salonId,
                customerPhoneNumber: phoneNumber,
                customerName: customerData.name,
                date: selectedDate.full,
                startTime: selectedTimeSlot,
                endTime: `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`,
                servicesJson: JSON.stringify(selectedServices.map(s => ({ id: s.id, name: s.name }))),
                finalPrice: finalPrice,
                depositAmount: finalPrice * 0.1, // Example deposit
                remainingAmount: finalPrice * 0.9,
                totalDurationHours: totalDuration,
                status: "Confirmed" // Assuming direct confirmation
            };

            try {
                const finalBooking = await fetchApi('create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingPayload)
                });
                showFinalConfirmation(finalBooking, null);
            } catch (error) {
                showFinalConfirmation(null, error.message);
            }
        }

        function showFinalConfirmation(bookingData, errorMessage) {
            const confIcon = document.getElementById('confirmationIcon');
            const confTitle = document.getElementById('confirmationTitle');
            if (errorMessage) {
                confIcon.innerHTML = `<svg class="mx-auto w-16 h-16 mb-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                confTitle.textContent = "ثبت رزرو ناموفق بود";
                document.getElementById('confirmationDetails').innerHTML = `<p class="text-center">${errorMessage}</p>`;
            } else {
                confIcon.innerHTML = `<svg class="mx-auto w-16 h-16 mb-4 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 16.17l7.59-7.59L19 10l-9 9z"></path></svg>`;
                confTitle.textContent = "ثبت با موفقیت انجام شد!";
                document.getElementById('confSalonName').textContent = selectedSalon.name;
                document.getElementById('confSalonAddress').textContent = `آدرس: ${selectedSalon.address}`;
                document.getElementById('confDate').textContent = toPersianNum(bookingData.date);
                document.getElementById('confTime').textContent = toPersianNum(bookingData.startTime);
            }
            navigateToStep(11);
        }

        function resetApp() {
            selectedSalon = null; selectedCategory = null; phoneNumber = '';
            customerData = null; selectedServices = []; selectedDate = null;
            selectedTimeSlot = null; dailyBookedSlots = {};
            clearAllErrors();
            initStep1();
            navigateToStep(1);
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initialAppLoadingDOM.style.display = 'none';
            mainAppContainerDOM.style.display = 'block';

            // Event Listeners
            document.getElementById('categoryFilter').addEventListener('change', applyFiltersAndPopulateSalons);
            document.getElementById('cityFilter').addEventListener('change', applyFiltersAndPopulateSalons);

            document.getElementById('btnGoToStep3FromCard').onclick = initStep3;
            document.getElementById('btnBackToStep2FromPhone').onclick = () => navigateToStep(2);
            document.getElementById('btnGoToStep4FromPhone').onclick = handlePhoneNumberSubmit;

            document.getElementById('btnBackToStep3FromOtp').onclick = () => navigateToStep(3);
            document.getElementById('btnGoToStep5FromOtp').onclick = handleUserOtpVerification;

            document.getElementById('btnBackToStep4FromCust').onclick = () => navigateToStep(4);
            document.getElementById('btnProceedFromCustomerInfo').onclick = handleCustomerDetailsSubmitStep5;

            document.getElementById('btnBackToStep5FromCatList').onclick = () => navigateToStep(5);

            document.getElementById('btnBackToStep6FromServices').onclick = () => {
                if (selectedSalon.categories && selectedSalon.categories.length === 1) { navigateToStep(5); } else { navigateToStep(6); }
            };
            document.getElementById('btnGoToStep8FromServices').onclick = () => { populateCalendarsStep8(); navigateToStep(8); };

            document.getElementById('btnBackToStep7FromDate').onclick = () => navigateToStep(7);
            document.getElementById('btnGoToStep9FromDate').onclick = () => populateTimeSlotsStep9();

            document.getElementById('btnBackToStep8FromTime').onclick = () => navigateToStep(8);
            document.getElementById('btnGoToStep10FromTime').onclick = handleFinalBooking;

            // Start the app
            initStep1();
            navigateToStep(1);
        });
    </script>
</body>
</html>
